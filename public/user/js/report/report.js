const calorieData = {
    "2025-03-28": {"consumed": 2539,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-03-29": {"consumed": 2421,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-03-30": {"consumed": 2554,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-03-31": {"consumed": 2432,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-01": {"consumed": 2478,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-02": {"consumed": 2471,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-03": {"consumed": 2591,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-04": {"consumed": 2588,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-05": {"consumed": 2590,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-06": {"consumed": 2564,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-07": {"consumed": 2445,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-08": {"consumed": 2445,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-09": {"consumed": 2512,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-10": {"consumed": 2486,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-11": {"consumed": 2437,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-12": {"consumed": 2429,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-13": {"consumed": 2603,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-14": {"consumed": 2470,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-15": {"consumed": 2462,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-16": {"consumed": 2544,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-17": {"consumed": 2538,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-18": {"consumed": 2490,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-19": {"consumed": 2462,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-20": {"consumed": 2486,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-21": {"consumed": 2519,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-22": {"consumed": 2606,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-23": {"consumed": 2438,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-24": {"consumed": 2508,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-25": {"consumed": 2439,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-26": {"consumed": 2532,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-27": {"consumed": 2422,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-28": {"consumed": 2505,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37}
};


export function renderReportPage() {
    return `
        <div class="user-name">하잇님</div>
        <div class="toggle-report-wrapper">
            <div class="toggle-meal-report toggle-report active">식사기록</div>
            <div class="toggle-weight-report toggle-report">몸무게</div>
        </div>

        <div id="mealReport">
            <div class="date">2025.04.30</div>
            <div class="amount-wrapper">
                <div class="amount">1,652</div>
                <div class="unit">kcal</div>
            </div>
            <div class="feedback-comment">조금 더 드셔야 해요</div>
            <div class="recommend-wrapper">
                <div class="recommend-food">추천음식 보러가기</div>
                <div class="icon">
                    <img src="/user/images/icon_arrow_red.png">
                </div>
            </div>
            <div class="period-button-wrapper">
                <div class="period-button active">1주</div>
                <div class="period-button">1달</div>
            </div>
            <div class="chart-container"> 
                <canvas id="reportChart"></canvas>
            </div>
        </div>


        <div id="weightReport" style="display:none">
            <div class="date">2025.04.30</div>
            <div class="amount-wrapper">
                <div class="amount">74</div>
                <div class="unit">kg</div>
            </div>
            <div class="feedback-comment">조금 더 드셔야 해요</div>
            <div class="recommend-wrapper">
                <div class="recommend-food">뭄무게 기록하기</div>
                <div class="icon">
                    <img src="/user/images/icon_arrow_red.png">
                </div>
            </div>
            <div class="period-button-wrapper">
                <div class="period-button active">1주</div>
                <div class="period-button">1달</div>
            </div>
        </div>
    `;
}

//식사기록 / 몸무게 토글 클릭시 그래프 뷰 변경
$(document).on('click', '.toggle-report', function () {
    $('.toggle-report').removeClass('active');

    $(this).addClass('active');

    if ($(this).hasClass('toggle-meal-report')) {
        $('#mealReport').show();
        $('#weightReport').hide();
    } else if ($(this).hasClass('toggle-weight-report')) {
        $('#weightReport').show();
        $('#mealReport').hide();
    }
});

$(document).on('click', '.period-button', function () {
    var wrapper = $(this).closest('.period-button-wrapper');
    wrapper.find('.period-button').removeClass('active');

    $(this).addClass('active');
});


// 오늘 날짜의 데이터를 저장할 변수
let currentData;

function updateReportData(date, consumed) {
    const dateElement = document.querySelector('#mealReport .date');
    const amountElement = document.querySelector('#mealReport .amount');

    if (dateElement && amountElement) {
        const formattedDate = date.replaceAll('-', '.'); // "YYYY-" 제거
        dateElement.textContent = formattedDate;
        amountElement.textContent = consumed ? consumed.toLocaleString() : '-';
    }
}

function getTodayData() {
    const today = new Date();
    const todayKey = today.toISOString().split('T')[0];
    return {
        date: todayKey,
        consumed: calorieData[todayKey]?.consumed
    };
}

let myChart; // Chart 인스턴스를 저장할 변수

export function initCalorieChart(days = 7) {
    const { labels, data } = getRecentData(days);
    const goalData = getRecentGoalData(days);

    const ctx = document.getElementById('reportChart')?.getContext('2d');
    if (!ctx) {
        console.error('reportChart element not found');
        return;
    }

    let gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0.5, "rgba(235, 133, 133, 0.16)");
    gradient.addColorStop(0.9, "rgba(255, 255, 255, 0.18)");
    const red500 = getComputedStyle(document.documentElement).getPropertyValue('--red500').trim();

    // 이전 차트가 존재하면 파괴
    if (myChart) {
        myChart.destroy();
    }

    // 초기 오늘 데이터 설정 및 UI 업데이트 (매번 차트 초기화 시 업데이트)
    currentData = getTodayData();
    updateReportData(currentData.date, currentData.consumed);

    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '섭취 칼로리',
                    data: data,
                    borderColor: red500,
                    borderWidth: 1,
                    backgroundColor: gradient,
                    pointBackgroundColor: red500,
                    pointRadius: 0,
                    pointHoverRadius: 3,
                    tension: 0.25,
                    fill: true,
                },
                {
                    label: '목표 칼로리 계단',
                    data: goalData,
                    borderColor: '#FFEDED',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    pointStyle: false,
                    stepped: true,
                    fill: false,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.25,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#4E4E4E',
                        font: {
                            size: 14
                        },
                        filter: function(legendItem, data) {
                            if (legendItem.text === '목표 칼로리 계단') {
                                return false;
                            }
                            return true;
                        }
                    }
                },
                annotation: {
                    annotations: {}
                },
                tooltip: {
                    enabled: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    min: 0,
                    max: 3000,
                    ticks: {
                        stepSize: 1000,
                        color: '#999',
                    },
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                },
                x: {
                    ticks: {
                        display: false,
                    },
                    grid: {
                        display: false,
                        drawBorder: false
                    }
                }
            },
            onHover: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const dateKey = labels[index];
                    const fullDateKey = `2025-${dateKey}`;
                    const consumedValue = calorieData[fullDateKey]?.consumed;
                    updateReportData(fullDateKey, consumedValue);
                }
            }
        }
    });
}

function getRecentData(days) {
    const today = new Date();
    const resultLabels = [];
    const resultData = [];

    for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const dateKey = date.toISOString().split('T')[0];

        if (calorieData[dateKey]) {
            resultLabels.push(dateKey.slice(5));
            resultData.push(calorieData[dateKey].consumed);
        } else {
            resultLabels.push(dateKey.slice(5));
            resultData.push(0);
        }
    }
    return { labels: resultLabels, data: resultData };
}

function getRecentGoalData(days) {
    const today = new Date();
    const resultData = [];

    for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const dateKey = date.toISOString().split('T')[0];

        if (calorieData[dateKey]) {
            resultData.push(calorieData[dateKey].target);
        } else {
            resultData.push(null);
        }
    }
    return resultData;
}

// 기간 버튼 클릭 이벤트 핸들러
$(document).on('click', '.period-button', function () {
    var wrapper = $(this).closest('.period-button-wrapper');
    wrapper.find('.period-button').removeClass('active');
    $(this).addClass('active');

    const period = $(this).text();
    let daysToShow = 7; // 기본값은 1달

    if (period === '1달') {
        daysToShow = 30;
    }

    initCalorieChart(daysToShow); // 선택된 기간에 따라 차트 다시 초기화
});

