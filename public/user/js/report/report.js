const calorieData = {
    "2025-03-28": {"consumed": 2539,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-03-29": {"consumed": 2421,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-03-30": {"consumed": 2554,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-03-31": {"consumed": 2432,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-01": {"consumed": 2478,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-02": {"consumed": 2471,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-03": {"consumed": 2591,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-04": {"consumed": 2588,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-05": {"consumed": 2590,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-06": {"consumed": 2564,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-07": {"consumed": 2445,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-08": {"consumed": 2445,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-09": {"consumed": 2512,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-10": {"consumed": 2486,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-11": {"consumed": 2437,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-12": {"consumed": 2429,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-13": {"consumed": 2603,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-14": {"consumed": 2470,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-15": {"consumed": 2462,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-16": {"consumed": 2544,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-17": {"consumed": 2538,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-18": {"consumed": 2490,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-19": {"consumed": 2462,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-20": {"consumed": 2486,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-21": {"consumed": 2519,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-22": {"consumed": 2606,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-23": {"consumed": 2438,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-24": {"consumed": 2508,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-25": {"consumed": 2439,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-26": {"consumed": 2532,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-27": {"consumed": 2422,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-28": {"consumed": 2505,"target": 2420,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-29": {"consumed": 1505,"target": 2320,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
    "2025-04-30": {"consumed": 2305,"target": 2320,"targetCarbo": 303,"targetProtein": 182,"targetFat": 54,"consumedCarbo": 206,"consumedProtein": 123,"consumedFat": 37},
};


export function renderReportPage() {
    return `
        <div class="user-name">하잇님</div>
        <div class="toggle-report-wrapper">
            <div class="toggle-meal-report toggle-report active">식사기록</div>
            <div class="toggle-weight-report toggle-report">몸무게</div>
        </div>

        <div id="mealReport">
            <div class="date">2025.04.30</div>
            <div class="amount-wrapper">
                <div class="amount">1,652</div>
                <div class="unit">kcal</div>
            </div>
            <div class="feedback-comment">조금 더 드셔야 해요</div>
            <div class="recommend-wrapper">
                <div class="recommend-food">추천음식 보러가기</div>
                <div class="icon">
                    <img src="/user/images/icon_arrow_red.png">
                </div>
            </div>
            <div class="period-button-wrapper">
                <div class="period-button active">1주</div>
                <div class="period-button">1달</div>
            </div>

            <div class="legend-wrapper">
                <div class="legend-box"></div>
                <div class="legend-label">목표 칼로리</div>
            </div>
            <div class="y-label">(Kcal)</div>
            
            <div class="chart-container"> 
                <canvas id="calorieChart"></canvas>
            </div>
        </div>


        <div id="weightReport" style="display:none">
            <div class="date">2025.04.30</div>
            <div class="amount-wrapper">
                <div class="amount">74</div>
                <div class="unit">kg</div>
            </div>
            <div class="feedback-comment">조금 더 드셔야 해요</div>
            <div class="recommend-wrapper">
                <div class="recommend-food">뭄무게 기록하기</div>
                <div class="icon">
                    <img src="/user/images/icon_arrow_red.png">
                </div>
            </div>
            <div class="period-button-wrapper">
                <div class="period-button active">1주</div>
                <div class="period-button">1달</div>
            </div>
        </div>

        <div id="tooltip"></div>
    `;
}

//식사기록 / 몸무게 토글 클릭시 그래프 뷰 변경
$(document).on('click', '.toggle-report', function () {
    $('.toggle-report').removeClass('active');

    $(this).addClass('active');

    if ($(this).hasClass('toggle-meal-report')) {
        $('#mealReport').show();
        $('#weightReport').hide();
    } else if ($(this).hasClass('toggle-weight-report')) {
        $('#weightReport').show();
        $('#mealReport').hide();
    }
});

$(document).on('click', '.period-button', function () {
    var wrapper = $(this).closest('.period-button-wrapper');
    wrapper.find('.period-button').removeClass('active');

    $(this).addClass('active');
});


// 오늘 날짜의 데이터를 저장할 변수
let currentData;

function updateReportData(date, consumed, target) {
    const dateElement = document.querySelector('#mealReport .date');
    const amountElement = document.querySelector('#mealReport .amount');
    const legendElement = document.querySelector('#mealReport .legend-label');

    if (dateElement && amountElement) {
        const formattedDate = date.replaceAll('-', '.'); 
        dateElement.textContent = formattedDate;
        amountElement.textContent = consumed ? consumed.toLocaleString() : '0';
        legendElement.textContent = '목표 칼로리 ' + (target ? target.toLocaleString() : '0');
    }
}

function getTodayData() {
    const today = new Date();
    const todayKey = today.toISOString().split('T')[0];
    return {
        date: todayKey,
        consumed: calorieData[todayKey]?.consumed,
        target: calorieData[todayKey]?.target
    };
}

let myChart; // Chart 인스턴스를 저장할 변수

export function initCalorieChart(days = 7) {
    const { labels, data } = getRecentData(days);
    const goalData = data.map(item => item.target); // target만 추출

    const ctx = document.getElementById('calorieChart')?.getContext('2d');
    if (!ctx) {
        console.error('calorieChart element not found');
        return;
    }

    let gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0.5, "rgba(235, 133, 133, 0.16)");
    gradient.addColorStop(0.9, "rgba(255, 255, 255, 0.18)");
    const red500 = getComputedStyle(document.documentElement).getPropertyValue('--red500').trim();

    if (myChart) {
        myChart.destroy();
    }

    currentData = getTodayData();
    updateReportData(currentData.date, currentData.consumed, currentData.target);

    const todayLabel = currentData.date.slice(5); // 'MM-DD'
    const todayIndex = labels.indexOf(todayLabel);

    const initialPointRadius = new Array(labels.length).fill(0);
    if (todayIndex !== -1) {
        initialPointRadius[todayIndex] = 3;
    }

    let pointReset = false;

    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '섭취 칼로리',
                    data: data.map(item => item.consumed), // consumed만
                    borderColor: red500,
                    borderWidth: 1,
                    backgroundColor: gradient,
                    pointBackgroundColor: red500,
                    pointRadius: initialPointRadius,
                    pointHoverRadius: 3,
                    tension: 0.25,
                    fill: true,
                },
                {
                    label: '목표 칼로리 계단',
                    data: goalData,
                    borderColor: '#FFEDED',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 0,
                    pointStyle: false,
                    stepped: true,
                    fill: false,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.3,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: { display: false },
                annotation: { annotations: {} },
                tooltip: {
                    enabled: false,
                    external: function (context) {
                        const tooltip = document.getElementById('tooltip');
                        const tooltipModel = context.tooltip;

                        if (tooltipModel.opacity === 0) {
                            tooltip.style.opacity = '0';
                            return;
                        }

                        const chart = context.chart;
                        const yScale = chart.scales.y;
                        const xScale = chart.scales.x;
                        const position = chart.canvas.getBoundingClientRect();

                        tooltip.style.opacity = '1';
                        tooltip.style.display = 'flex';
                        tooltip.style.justifyContent = 'center';
                        tooltip.style.alignItems = 'center';
                        tooltip.style.flexDirection = 'column';

                        const dataPoint = tooltipModel.dataPoints?.[0];
                        const label = dataPoint?.label || '';
                        const index = dataPoint?.dataIndex;

                        const zeroY = yScale.getPixelForValue(0);
                        const pointX = xScale.getPixelForValue(index);
                        const verticalBarHeight = yScale.height;

                        const tooltipWidth = tooltip.offsetWidth;
                        const tooltipTop = position.top + window.pageYOffset + zeroY - verticalBarHeight - 22;
                        const tooltipLeft = position.left + window.pageXOffset + pointX - (tooltipWidth / 2);

                        tooltip.style.left = `${tooltipLeft}px`;
                        tooltip.style.top = `${tooltipTop}px`;

                        tooltip.innerHTML = `
                            <div class="tooltip-content">
                                <div class="tooltip-date">${label}</div>
                                <div class="vertical-bar"></div>
                            </div>
                        `;

                        requestAnimationFrame(() => {
                            const bar = tooltip.querySelector('.vertical-bar');
                            if (bar) {
                                bar.style.height = `${verticalBarHeight}px`;
                            }
                        });
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    min: 0,
                    max: 3000,
                    ticks: { stepSize: 1000, color: '#999' },
                    grid: { display: false, drawBorder: false }
                },
                x: {
                    ticks: { display: false },
                    grid: { display: false, drawBorder: false }
                }
            },
            onHover: (event, elements) => {
                if (!pointReset) {
                    myChart.data.datasets[0].pointRadius = 0; // 초기 점 제거
                    myChart.update('none');
                    pointReset = true;
                }

                if (elements.length > 0) {
                    const index = elements[0].index;
                    const dayData = data[index];
                    if (dayData) {
                        updateReportData(dayData.date, dayData.consumed, dayData.target);
                    }
                }
            }
        }
    });
}


function getRecentData(days) {
    const today = new Date();
    const resultLabels = [];
    const resultData = [];

    for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const dateKey = date.toISOString().split('T')[0]; // YYYY-MM-DD

        resultLabels.push(dateKey.slice(5)); // MM-DD

        resultData.push({
            date: dateKey,
            consumed: calorieData[dateKey]?.consumed ?? 0,
            target: calorieData[dateKey]?.target ?? 0
        });
    }
    return { labels: resultLabels, data: resultData };
}


// 기간 버튼 클릭 이벤트 핸들러
$(document).on('click', '.period-button', function () {
    var wrapper = $(this).closest('.period-button-wrapper');
    wrapper.find('.period-button').removeClass('active');
    $(this).addClass('active');

    const period = $(this).text();
    let daysToShow = 7; // 기본값은 1달

    if (period === '1달') {
        daysToShow = 30;
    }

    initCalorieChart(daysToShow); // 선택된 기간에 따라 차트 다시 초기화
});

$(document).on('touchend', function () {
    const tooltip = document.getElementById('tooltip');
    
    if (tooltip) {
        console.log("터치끝");
        tooltip.style.opacity = '0';  // 툴팁을 숨깁니다.
        tooltip.style.display = 'none';  // 툴팁을 아예 숨깁니다.
    }
});